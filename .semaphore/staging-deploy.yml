version: v1.0
name: staging-deploy
agent:
  machine:
    type: e1-standard-4
    os_image: ubuntu1804
blocks:
  - name: Deploy
    task:
      jobs:
        - name: Deploy to staging
          commands:
            - chmod 600 /home/semaphore/.ssh/id_rsa_medagregator-api
            - ssh-add /home/semaphore/.ssh/id_rsa_medagregator-api
            - ssh-keyscan -H demo.medagregator.ru >> ~/.ssh/known_hosts
            - server_conn="deploy@demo.medagregator.ru"
            - 'scp -r $server_conn:~/medagregator_deploy/ ~/'
            - cp /home/semaphore/config/.env.demo-staging ~/medagregator_deploy/preBuiltFront/.env
            - printenv | grep ^FEATURE_ >> ~/medagregator_deploy/preBuiltFront/.env
            - 'scp ~/medagregator_deploy/preBuiltFront/.env $server_conn:~/medagregator_deploy/preBuiltFront/'
            - cd ~/medagregator_deploy/
            - docker-compose build --build-arg SSH_PRIVATE_KEY="$(cat ~/.ssh/id_rsa_medagregator-api)" front
            - docker rmi -f $(docker images -q --filter label=stage=intermediate)
            - 'docker save -o frontend_images.tar medagregator_deploy_front:latest'
            - 'scp frontend_images.tar $server_conn:~/'
            - ssh $server_conn "docker load -i frontend_images.tar"
            - ssh $server_conn "cd ~/medagregator_deploy && docker-compose up -d front"
            - ssh $server_conn "docker image prune -f"
      secrets:
        - name: medagregator-api
        - name: medagregator-staging-client
